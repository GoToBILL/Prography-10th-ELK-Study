# Elasticsearch 문서 업데이트와 불변성(Immutability)

## 개요

Elasticsearch에서 문서를 업데이트할 때, 기존 문서를 **수정하는 것이 아니라 새로운 버전을 추가**하는 방식으로 업데이트를 진행합니다. 이 특성을 **불변성**이라고 부르며, Elasticsearch의 핵심적인 특징 중 하나입니다.

## 불변성(Immutability)이란?

불변성은 문서를 **수정하지 않고 새로운 버전을 생성**하는 개념입니다.

예를 들어, 고객 정보를 수정할 때 기존 문서를 덮어쓰는 대신, **새로운 버전의 문서를 만들어서 기존 문서의 자리에 추가**하는 방식입니다.

## 불변성의 장점

### 1. 일관성(Consistency)

#### 왜 중요한가요?
분산 시스템에서는 여러 서버나 노드가 데이터를 동시에 다루기 때문에, 같은 데이터를 여러 번 수정하려는 상황이 발생할 수 있습니다. 이때, **경쟁 조건(race condition)이나** **데이터 손상**이 발생할 수 있습니다.

예를 들어, 두 사람이 동시에 같은 문서를 수정하려고 하면, 한 사람의 변경 내용이 다른 사람의 내용을 덮어쓰게 되어 데이터가 꼬일 수 있습니다.

#### 불변성 덕분에:
문서를 수정하는 대신 새로운 버전을 추가하는 방식이기 때문에 **동시에 수정되는 상황을 방지**할 수 있습니다. 즉, **여러 사람이 동시에 문서를 수정하는 위험**을 줄일 수 있고, 데이터의 **일관성**이 더 잘 유지됩니다.

### 2. 버전 관리(Versioning)

#### 왜 중요한가요?
Elasticsearch에서는 문서를 수정할 때마다 **새로운 버전**이 만들어집니다. 이 새로운 버전은 기존 문서의 복사본이므로, 이전 버전들을 쉽게 **추적하고 관리**할 수 있습니다.

#### 불변성 덕분에:
문서의 버전 관리가 매우 용이해집니다. 예를 들어, 문서가 여러 번 수정되었을 때, 이전 버전들을 **참조**하거나 **비교**할 수 있습니다.

이를 통해 **낙관적 동시성 제어**와 같은 기능을 활용할 수 있습니다. 이는 여러 사용자가 동시에 문서를 수정할 때 발생할 수 있는 충돌을 예방하는 데 유용합니다.

### 3. 성능(Performance)

#### 왜 중요한가요?
Elasticsearch는 문서를 수정하는 방식이 아닌, **추가 작업(append-only)** 방식으로 설계되어 있습니다. 즉, 문서를 수정할 때마다 기존 문서를 덮어쓰는 것이 아니라 새로운 문서를 **추가**하는 방식으로 처리됩니다. 이 방식은 성능 측면에서 매우 효율적입니다.

> **덮어쓰기 방식**을 사용하면 기존 데이터를 **수정**해야 하므로, **데이터가 존재하는 위치를 찾아서 수정**하고, 그 이후에 **인덱스를 갱신**해야 합니다. 이런 방식은 파일 시스템에서 데이터를 수정할 때 많은 작업을 수반하게 되어 성능이 떨어질 수 있습니다.

#### 불변성 덕분에:
기존 데이터를 덮어쓰지 않고 **새로운 데이터를 추가하는** 방식은 인덱싱과 검색 성능을 **최적화**합니다.

데이터를 삭제하거나 수정하는 것보다 데이터를 추가하는 방식이 더 효율적이므로, Elasticsearch는 더 빠르고 효과적으로 데이터를 처리할 수 있습니다.

## 업데이트 요약

**불변성**은 문서를 수정하는 대신 **새로운 버전을 생성**하는 방식입니다.

이를 통해 데이터의 **일관성**을 보장하고, **버전 관리**가 용이해지며, **성능**이 최적화됩니다.

**Elasticsearch**는 추가만 되는 **작업(append-only 작업)에** 최적화되어 있어, 데이터를 수정하는 대신 새로운 데이터를 추가하는 방식이 더 효율적입니다.

이러한 불변성 덕분에 Elasticsearch는 매우 안정적이고 성능이 좋은 분산 검색 시스템이 될 수 있습니다.

## 문서 삭제 작동 방식

Elasticsearch에서의 삭제 작업은 일반적인 삭제와 달리 즉시 물리적으로 삭제되지 않습니다:

1. **삭제 요청**: 사용자나 시스템이 Elasticsearch에 문서 삭제를 요청합니다.
2. **삭제 마킹**: 문서가 삭제된 것으로 **표시**되지만, 실제 문서는 삭제되지 않습니다.
3. **세그먼트 병합**: 시간이 지나면서 Elasticsearch는 **배경 작업**으로 세그먼트 병합을 진행하고, 삭제된 문서가 포함된 세그먼트를 제거합니다.
4. **실제 삭제**: 병합 작업 중에 **삭제된 문서가 포함된 세그먼트**가 물리적으로 제거되며, 문서가 **완전히 삭제**됩니다.

### 삭제 동작 요약

Elasticsearch에서는 **즉시 삭제**를 하지 않고, **삭제된 상태로 마킹**만 한 후, 배경에서 **세그먼트 병합**을 통해 실제 삭제를 수행합니다.

이렇게 하는 이유는 **성능 최적화**와 **시스템 부하 절감**을 위해서입니다. 삭제 작업을 바로 처리하는 것보다, **나중에 일괄적으로 처리하는 방식이 시스템 자원을 더 효율적으로 사용할 수 있습니다.**
