# Elasticsearch 라우팅(Routing)

라우팅은 Elasticsearch에서 문서가 어느 샤드(Shards)에 저장될지 결정하는 메커니즘입니다.

올바르게 라우팅을 사용하면 특히 **대규모 데이터셋**이나 **특정 쿼리 패턴**에 대해 성능과 효율성을 크게 향상시킬 수 있습니다.

## 라우팅(Routing) 개념

- **라우팅**은 문서가 **어떤 샤드에 저장될지 결정하는 방법**입니다. 기본적으로 Elasticsearch는 문서의 ID를 기반으로 **해시(Hash)** 값을 계산하여, 그 값을 **기본 샤드 수**로 나누어 저장할 샤드를 결정합니다.

### 기본 라우팅(Default Routing)

- 기본적으로 문서의 ID를 해시한 후, **샤드 수**로 나누어 해당 문서를 어느 샤드에 배치할지 결정합니다. 즉, 문서 ID를 이용해 **샤드를 결정**하는 방식입니다.

- **예시**: `shard = hash(document_id) % number_of_primary_shards`

  예를 들어, 문서의 ID가 `123`이면, `hash(123) % number_of_primary_shards` 계산을 통해 샤드가 결정됩니다.

### 사용자 정의 라우팅(Custom Routing)

- 문서가 어느 샤드에 저장될지 **사용자가 지정한 값(라우팅 키)**을 사용하여 결정할 수 있습니다. 이렇게 하면 특정 **쿼리 패턴**에 맞는 문서들이 같은 샤드에 저장되도록 할 수 있어 **성능 향상**에 도움이 됩니다.

- **예시**: `POST /my_index/_doc/1?routing=user123`처럼 `routing` 파라미터에 `user123`을 전달하면, Elasticsearch는 이 값에 따라 문서를 특정 샤드에 저장합니다.

- 이렇게 하면 관련 문서들이 **같은 샤드에 저장**되므로, 같은 사용자나 특정 그룹의 데이터를 한 샤드에서 처리할 수 있어 **쿼리 성능**이 향상됩니다.

## 사용자 정의 라우팅의 장점

### 향상된 쿼리 성능

- 관련된 문서들이 **같은 샤드**에 저장되면, Elasticsearch는 **샤드 수**를 줄여서 검색할 수 있기 때문에 **쿼리 속도**가 빨라집니다. 여러 샤드를 검색할 필요가 없으므로 응답 시간이 단축됩니다.

### 데이터 지역성(Data Locality)

- 사용자 정의 라우팅을 통해, **관련 데이터**가 같은 샤드에 저장되므로 **데이터 지역성**을 유지할 수 있습니다.

- 이는 **멀티-테넌시**(multi-tenancy) 환경이나 **파티셔닝된 데이터**에서 특히 유용합니다. 예를 들어, 각 사용자(`user123`, `user456`)의 데이터를 별도의 샤드에 저장하여, 해당 사용자의 데이터만 빠르게 조회할 수 있습니다.

## 사용자 정의 라우팅 예시

### 1. 문서 삽입

```json
POST /my_index/_doc/1?routing=user123
{
  "title": "Elasticsearch Basics",
  "author": "John Doe",
  "publish_date": "2024-05-09",
  "tags": ["search", "analytics"]
}
```

- `routing=user123`은 이 문서가 `user123`라는 라우팅 키를 기준으로 특정 샤드에 저장되도록 합니다. 이 문서는 `user123`에 해당하는 샤드에 저장됩니다.

### 2. 검색

```json
GET /my_index/_search?routing=user123
{
  "query": {
    "match": {
      "author": "John Doe"
    }
  }
}
```

- `routing=user123`을 사용하여, Elasticsearch는 `user123`에 해당하는 샤드에서만 데이터를 검색합니다. 이렇게 하면 **쿼리 성능**이 개선됩니다.

## 사용자 정의 라우팅의 고려사항

### 샤드 불균형(Shard Imbalance)

- 사용자 정의 라우팅을 사용할 때, **라우팅 키**가 불균형적으로 사용되면 **데이터가 특정 샤드에 집중**될 수 있습니다. 이 경우 일부 샤드에는 많은 데이터가 집중되고, 다른 샤드는 비어 있을 수 있습니다. 이런 불균형은 **성능 저하**를 초래할 수 있으므로, **라우팅 키**를 신중하게 선택해야 합니다.

### 라우팅 키 변경 불가

- 한 번 라우팅 키가 지정되면, 해당 문서의 라우팅 키를 변경하려면 **재색인(reindexing)** 작업을 해야 합니다.
  Elasticsearch는 문서를 처음에 삽입할 때 지정한 라우팅 키에 따라 샤드를 결정하므로, **라우팅 키를 변경하면 문서가 다른 샤드로 이동**하게 되므로, 이를 해결하기 위해 재색인이 필요합니다.

## 결론

- **라우팅**은 Elasticsearch에서 문서가 어떤 샤드에 저장될지 결정하는 중요한 메커니즘입니다.

- **기본 라우팅**은 문서 ID를 기반으로 샤드를 결정하지만, **사용자 정의 라우팅**은 라우팅 키를 사용하여 특정 샤드에 문서를 저장하게 하여, **쿼리 성능을 향상**시키고 **데이터 지역성**을 확보할 수 있습니다.

- 하지만 **라우팅 키가 불균형하게 사용될 경우** 데이터 분포에 문제가 발생할 수 있고, **라우팅 키 변경 시 재색인**이 필요하다는 점도 유의해야 합니다.
