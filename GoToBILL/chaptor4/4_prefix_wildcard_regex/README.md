# Elasticsearch의 패턴 검색 쿼리

Elasticsearch에서는 특정 패턴을 가진 데이터를 검색하기 위한 다양한 term-level 쿼리를 제공합니다. 여기서는 세 가지 주요 패턴 검색 쿼리에 대해 알아보겠습니다.

## 1. Prefix 검색

Prefix 검색은 특정 접두사로 시작하는 필드 값을 가진 문서를 찾는 쿼리입니다.

### 특징
- 필드 값이 **지정한 접두사로 시작**하는 문서를 검색합니다.
- 완전한 값을 모를 때 유용합니다.
- 키워드 필드에서 사용할 경우 **대소문자를 구분**합니다.

### 사용 사례
- 자동완성 기능: "iph"로 검색하면 "iPhone", "iPhone 12", "iPhone Charger" 등을 찾을 수 있습니다.

### 예시
```
GET /products/_search
{
  "query": {
    "prefix": {
      "product_name": "iph"
    }
  }
}
```

### 주의사항
- 짧은 접두사로 검색하거나 대규모 데이터셋에서 사용할 경우 성능 문제가 발생할 수 있습니다.
- 인덱스 내의 모든 용어를 스캔해야 할 수 있으므로 주의가 필요합니다.

## 2. Wildcard 검색

Wildcard 검색은 와일드카드 문자를 사용하여 특정 패턴과 일치하는 문서를 찾는 쿼리입니다.

### 와일드카드 문자
- `*`: 0개 이상의 문자와 일치 (빈 문자열 포함)
- `?`: 정확히 1개의 문자와 일치

### 특징
- 필드 값이 지정한 패턴과 일치하는 문서를 검색합니다.
- 복잡한 패턴 매칭이 필요할 때 유용합니다.

### 예시
```
GET /products/_search
{
  "query": {
    "wildcard": {
      "product_name": "i*one"
    }
  }
}
```

### 주의사항
- 와일드카드 쿼리는 리소스를 많이 사용할 수 있습니다.
- 특히 패턴 시작에 와일드카드를 사용하는 경우(`*phone`와 같은) 성능이 크게 저하될 수 있습니다.
- 가능하면 prefix 쿼리나 다른 대안을 고려하세요.

## 3. 정규 표현식(Regex) 검색

정규 표현식 검색은 강력한 패턴 매칭 기능을 제공하는 쿼리입니다.

### 일반적인 정규 표현식 패턴
- `.`: 임의의 한 문자와 일치
- `.*`: 임의의 문자열(0개 이상의 문자)과 일치
- `[abc]`: a, b, c 중 하나의 문자와 일치
- `[a-z]`: a부터 z까지의 소문자 중 하나와 일치
- `[0-9]`: 0부터 9까지의 숫자 중 하나와 일치

### 예시
```
GET /products/_search
{
  "query": {
    "regexp": {
      "product_code": "[A-Z]{2}[0-9]{4}"
    }
  }
}
```
이 쿼리는 대문자 2개로 시작하고 그 뒤에 숫자 4개가 오는 제품 코드를 검색합니다.

### 주의사항
- 정규 표현식 쿼리는 계산 비용이 높을 수 있습니다.
- 복잡한 패턴이나 대규모 데이터셋에서는 성능 문제가 발생할 수 있습니다.
- 가능하면 더 효율적인 검색 방법을 먼저 고려하세요.

## 공통 권장사항

1. **성능 최적화**: 
   - 가능하면 패턴의 시작부분을 고정하여 사용하세요 (예: `apple*`는 `*apple`보다 효율적)
   - 필터 컨텍스트에서 사용하여 캐싱 이점을 활용하세요

2. **대안 고려**:
   - 텍스트 분석과 토큰화를 통한 전체 텍스트 검색
   - n-gram 토큰화를 사용한 부분 매칭
   - 완성(completion) 서제스터를 사용한 자동완성

3. **실제 예시**:
```
GET /my_index/_search
{
  "query": {
    "bool": {
      "filter": [
        {
          "prefix": {
            "user.id": "kim"
          }
        }
      ],
      "must": [
        {
          "match": {
            "description": "electronics"
          }
        }
      ]
    }
  }
}
```

이 쿼리는 ID가 "kim"으로 시작하는 사용자의 문서 중에서 설명에 "electronics"가 포함된 문서를 검색합니다.
