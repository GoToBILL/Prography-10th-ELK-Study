# Elasticsearch 쓰기 작업 (Write Operations)

## 1. Client Request

- 클라이언트는 **문서를 Elasticsearch에 저장하려는 요청**을 보냅니다. 이 요청에는 **문서의 내용**과 **어떤 인덱스**에 문서를 저장할지 정보가 포함됩니다.
- 이 요청은 **Elasticsearch의 코디네이팅 노드**로 전송됩니다. **코디네이팅 노드**는 이 요청을 **분석**하고, 문서를 저장할 **샤드**를 결정합니다.

## 2. Document Routing

- **코디네이팅 노드**는 이 요청을 **어떤 샤드**에 전달할지 결정합니다. 기본적으로 **문서의 ID**를 **해시**하여 **샤드**를 결정합니다. 그러나 **사용자 정의 라우팅**을 사용할 수도 있습니다.

## 3. Primary Shard Processing 

- 요청이 프라이머리 **샤드**로 전달되면, 해당 샤드는 문서의 **저장**을 처리하고 **시퀀스 번호**를 할당합니다.

## 4. Translog

- **트랜슬로그**는 **프라이머리 샤드의** **쓰기 작업의 기록**을 저장하는 **쓰기 앞선 로그**(write-ahead log)입니다. 이를 통해 Elasticsearch는 **장애 발생 시 데이터 복구**가 가능하도록 보장합니다.

## 5. Replication

- 주 샤드에서 **쓰기 작업**을 완료하면, 이 작업은 **모든 복제 샤드**로 전달됩니다. 복제 샤드는 **시퀀스 번호와 primary term**을 포함한 작업을 처리합니다.

## 6. Global Checkpoint Update

- **글로벌 체크포인트**는 모든 **복제 샤드**가 동일한 시퀀스 번호를 **확인하고 처리**한 후에 업데이트됩니다.

![](https://file.notion.so/f/f/87d240b6-b6a0-4d94-b759-5a1349dc8070/4365556b-e4cb-46b1-8beb-33eb4303e1d5/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-04-14_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.52.06.png?table=block&id=1d5d933d-39cc-80e2-bd9c-c80138c92b0f&spaceId=87d240b6-b6a0-4d94-b759-5a1349dc8070&expirationTimestamp=1745424000000&signature=5Qo4UtxAkJi5uuz_y35OySgDSDFvKpH5x_ik0SN0Vnk&downloadName=%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA+2025-04-14+%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE+2.52.06.png)

**여기서 보면 프라이머리 샤드는 아직 모든 레플리카의 전파를 완수 못 했기 때문에 글로벌 체크 포인트가 99입니다.**

![](https://file.notion.so/f/f/87d240b6-b6a0-4d94-b759-5a1349dc8070/32369579-c3b8-4c7e-9738-3fd3b41eaef4/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-04-14_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.53.05.png?table=block&id=1d5d933d-39cc-802e-a832-d8392b71447b&spaceId=87d240b6-b6a0-4d94-b759-5a1349dc8070&expirationTimestamp=1745424000000&signature=pg-Y0X3XeaAu9JYDrcACP60Ui9-CPO5CAuFVnJMhnaw&downloadName=%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA+2025-04-14+%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE+2.53.05.png)

## 7. Acknowledgment

- **코디네이팅 노드**는 **주 샤드**와 **모든 복제 샤드**가 **쓰기 작업**을 **완료했다는 응답을 받을 때까지** 기다립니다.
- 모든 샤드가 **쓰기 작업을 성공적으로 완료**했다고 응답하면, **코디네이팅 노드**는 클라이언트에게 **성공 응답**을 보냅니다.

---

## 중요 개념들

1. **Primary Term (주 샤드 번호)**:

2. **Sequence Number (시퀀스 번호)**:

3. **Translog (트랜슬로그)**:

4. **Checkpoint (체크포인트)**:

---

## 요약

- **클라이언트 요청** → **코디네이팅 노드**로 전달 → **샤드 결정 및 라우팅**
- **주 샤드**에서 문서 처리 및 **시퀀스 번호, primary term** 할당
- **복제 샤드**로 작업 전달 및 **로컬 체크포인트** 업데이트
- **글로벌 체크포인트** 업데이트 후 **확인 응답**을 클라이언트로 전송

이 전체 과정은 **분산 시스템**인 Elasticsearch에서 **데이터의 일관성, 복제, 장애 복구** 등을 보장하며, 효율적으로 데이터를 처리하고 저장할 수 있도록 도와줍니다.

> **프라이머리 샤드**가 **업데이트**되고 **새로운 노드로 재배치**되었지만, 아직 이전 노드에서 삭제되지 않은 경우, **샤드가 두 개**가 될 수 있습니다. 
> 
> 이 상황에서 **레플리카 샤드**가 어떤 **프라이머리 샤드**에게 **전파받아야 하나?**
> 
> - **프라이머리 샤드**는 **Primary Term**과 **Sequence Number**라는 메타데이터를 사용하여 **상태**를 관리합니다.
>
>- **레플리카 샤드**는 이 **Primary Term**과 **Sequence Number**를 참조하여 어떤 **프라이머리 샤드**에서 데이터를 받아올지를 결정합니다.