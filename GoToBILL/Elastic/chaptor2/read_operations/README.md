# Elasticsearch 읽기 작업 (Read Operations)

Elasticsearch는 분산 시스템이므로 데이터를 읽는 과정이 여러 단계를 거칩니다. 이 과정은 **클라이언트의 요청**에서 **응답을 반환**하기까지 여러 가지 컴포넌트를 포함합니다.

## 1. Client Request (클라이언트 요청)

- **클라이언트**가 Elasticsearch에 요청을 보냅니다. 이 요청은 다양한 종류가 될 수 있습니다:
  - **검색 쿼리**: 문서 검색
  - **문서 ID로 조회**: 특정 ID에 해당하는 문서 조회
  - **집계(aggregation)**: 특정 기준에 따른 데이터 집계

- 이 요청은 **Elasticsearch 노드**로 전송되며, 일반적으로 **코디네이팅 노드**                   로 전달됩니다.

## 2. Coordinating Node (코디네이팅 노드)

- **코디네이팅 노드**는 요청을 받아 **해석**하고, 어떤 **인덱스**와 **샤드**에 쿼리를 실행해야 할지 결정합니다.

## 3. Routing (라우팅)

- **라우팅**은 요청이 어느 샤드로 보내질지 결정하는 과정입니다.
- 각 인덱스는 여러 샤드로 나뉘며, 각 샤드는 **primary shard**와 하나 이상의 **replica shard**를 가집니다.
- 요청이 실행될 때, **코디네이팅 노드**는 **어떤 샤드 복사본**(primary shard 또는 replica shard)에 요청을 보낼지 결정합니다. 이를 통해 **부하 분산**을 할 수 있습니다.

## 4. Shard Level Execution (샤드 레벨 실행)

- 요청이 **각 샤드**로 전달되면, 해당 샤드가 **로컬로** 쿼리를 실행합니다.
- **primary shard** 또는 **replica shard**에서 쿼리를
 처리합니다. 이 선택은 **부하 분산**과 관련된 설정에 따라 달라질 수 있습니다.
- 샤드는 해당 문서의 **검색 쿼리**나 **ID 조회** 작업을 **로컬에서 실행**하고 결과를 코디네이팅 노드로 반환합니다.

## 5. Aggregation and Reduction (집계 및 축소)

- **샤드에서 쿼리가 실행된 후, 각 샤드는 결과를 코디네이팅 노드로 보냅니다.**
- **코디네이팅 노드**는 여러 샤드에서 반환된 결과를 **집계**하여 **최종 응답**을 만듭니다. 예를 들어, 여러 샤드에서 결과를 병합하거나 **최종 집계**를 수행하여 클라이언트에 전송할 수 있습니다.
- **검색 쿼리**에서는 각 샤드가 **결과를 반환**하고, **집계 쿼리**에서는 각 샤드가 **집계된 값을 반환**합니다.

## 6. Response to Client (클라이언트로 응답 전송)

- 모든 샤드에서 결과가 집계되면, 코디네이팅 노드는 이를 **최종 응답으로 합치고** 클라이언트에게 반환합니다.

## 7. Adaptive Replica Selection (적응형 복제본 선택)

- **Adaptive Replica Selection**은 읽기 작업을 더 효율적으로 처리하기 위해 동적으로 **최적의 샤드 복사본(primary or replica)을** 선택하는 방법입니다.
- **ARS의 목적**: 읽기 성능을 높이기 위해, 요청을 처리할 때 **가장 빠른 응답을 하는 복제본**을 선택합니다.

### ARS의 장점:

1. **성능 향상**:
   - ARS는 읽기 요청을 처리할 때 **가장 빠른 응답을 제공하는 샤드**를 선택하여 성능을 최적화합니다. 이는 **읽기 속도**를 향상시키고, **응답 시간**을 단축시킵니다.

2. **부하 분산(Load Balancing)**:
   - 읽기 요청이 분산되어 처리되므로, 시스템의 **전체 부하**가 균등하게 분배됩니다. 이는 **전체 시스템 성능**을 향상시키고, **노드가 과부하되지 않도록** 돕습니다.

3. **응답 시간 단축**:
   - 최적의 샤드 복사본을 선택함으로써, **응답 지연(latency)을** 줄이고 **전체 클러스터의 응답 시간**을 개선합니다.

![구조](https://file.notion.so/f/f/87d240b6-b6a0-4d94-b759-5a1349dc8070/8f61908e-b789-4ae4-bd97-4123953fd146/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-04-14_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.30.41.png?table=block&id=1d5d933d-39cc-809f-9fa8-ebe351821ae8&spaceId=87d240b6-b6a0-4d94-b759-5a1349dc8070&expirationTimestamp=1745416800000&signature=1SPfxYkOKuvQFB4HWimHGSc0rwMuOIBGEEZKKVrMj_Q&downloadName=%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA+2025-04-14+%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE+2.30.41.png)

## 결론

Elasticsearch는 데이터를 읽는 과정에서 **다양한 샤드**를 활용하여 **부하 분산**을 처리하고, **응답 시간을 최적화**합니다.

**Adaptive Replica Selection**은 복제본을 선택하는 동적인 방식으로 읽기 성능을 향상시키고, **클러스터 전체 성능을 최적화**하는 데 도움을 줍니다.

이 모든 과정은 Elasticsearch의 분산 특성에 맞춰 **효율적인 쿼리 처리**와 **빠른 응답을 제공**하는 중요한 요소입니다.
