# Elasticsearch의 Date 타입 처리

## 개요

Elasticsearch는 다양한 형식과 방법으로 날짜 타입을 처리하며, 이는 여러 사용 사례에 맞게 유연하게 적용할 수 있습니다.

## 날짜 감지 (Date Detection)

Elasticsearch에 문서를 인덱싱할 때, 내장된 날짜 형식 중 하나와 일치하는 필드가 있으면 자동으로 날짜 필드로 감지합니다. 하지만 이러한 자동 감지는 모호성을 야기할 수 있으므로, 매핑에서 날짜 형식을 명시적으로 정의하는 것이 좋습니다.

예를 들어, 문자열 "2021-01-01"은 날짜로 자동 감지될 수 있지만, "01/01/2021"은 Elasticsearch의 기본 형식이 아니라면 문자열로 처리될 수 있습니다.

## 날짜 형식 (Date Formats)

Elasticsearch는 여러 날짜 형식을 지원합니다. 기본 날짜 형식은 `strict_date_optional_time||epoch_millis`입니다. 이는 다음을 의미합니다:

1. 먼저 `strict_date_optional_time` 형식으로 날짜를 파싱하려고 시도합니다.
   - 이 형식은 ISO8601 형식의 날짜(YYYY-MM-DD)와 선택적인 시간 요소(THH:mm:ss.SSSZ)를 허용합니다.
   - 예: "2024-06-07T12:00:00Z" 또는 "2024-06-07"

2. 만약 첫 번째 시도가 실패하면, `epoch_millis` 형식으로 파싱을 시도합니다.
   - 이 형식은 Unix 에포크(1970년 1월 1일 00:00:00 UTC)로부터의 밀리초를 나타냅니다.
   - 예: 1717761600000 (2024년 6월 7일 12:00:00 UTC)

## 매핑에서 날짜 필드 정의

인덱스의 매핑을 정의할 때, `format` 파라미터를 사용하여 날짜 필드의 형식을 지정할 수 있습니다. 이를 통해 Elasticsearch가 인덱싱 및 쿼리 시 날짜를 정확하게 파싱하도록 보장할 수 있습니다.

```
PUT /my_index
{
  "mappings": {
    "properties": {
      "created_at": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      }
    }
  }
}
```

위 예제에서는 세 가지 날짜 형식을 지원하도록 정의했습니다:
- "yyyy-MM-dd HH:mm:ss" (예: "2024-06-07 12:00:00")
- "yyyy-MM-dd" (예: "2024-06-07")
- "epoch_millis" (예: 1717761600000)

## 다양한 날짜 형식 사용 예시

다음은 여러 형식의 날짜를 Elasticsearch에 저장하는 예시입니다:

```
POST /date_playground/_doc/1
{
  "date_default": "2024-06-07T12:00:00Z",
  "date_custom_format": "2024-06-07 12:00:00",
  "date_iso8601": "2024-06-07T12:00:00.000Z",
  "date_millis": 1717761600000
}
```

위 예시에서:
- `date_default`: 기본 ISO8601 형식의 날짜
- `date_custom_format`: 사용자 정의 형식의 날짜
- `date_iso8601`: 밀리초 단위까지 포함한 ISO8601 형식
- `date_millis`: Unix 에포크로부터의 밀리초

## 날짜 검색 시 주의사항

Elasticsearch에서 날짜 필드를 검색할 때는 중요한 제약사항이 있습니다:

1. **검색 시 형식 제한**: 날짜 필드를 검색할 때는 인덱싱 시 정의된 형식이 아닌, Elasticsearch의 내부 날짜 형식만 사용 가능합니다. 즉, 사용자 정의 날짜 형식을 직접 쿼리에 사용할 수 없습니다.

2. **쿼리에서 사용 가능한 날짜 형식**:
   - ISO8601 형식 (예: "2024-06-07T12:00:00Z")
   - 에포크 밀리초 (예: 1717761600000)
   - 날짜 수학 표현식 (예: "now-1d", "now/d")

3. **잘못된 검색 예시**:
   ```
   // 이런 형식은 작동하지 않습니다
   GET /my_index/_search
   {
     "query": {
       "range": {
         "created_at": {
           "gte": "06/07/2024",  // 커스텀 포맷은 검색 시 사용 불가
           "lte": "06/10/2024"
         }
       }
     }
   }
   ```

4. **올바른 검색 예시**:
   ```
   GET /my_index/_search
   {
     "query": {
       "range": {
         "created_at": {
           "gte": "2024-06-07",  // ISO 형식 사용
           "lte": "2024-06-10",
           "format": "yyyy-MM-dd"  // 파싱 힌트 제공
         }
       }
     }
   }
   ```

5. **날짜 변환 솔루션**: 애플리케이션에서 사용자 정의 형식의 날짜를 처리해야 한다면, 쿼리 전에 해당 날짜를 Elasticsearch가 이해할 수 있는 형식으로 변환해야 합니다.

## 날짜 처리 시 주의사항

1. **시간대(Timezone)**: 날짜가 특정 시간대에 기반한 경우, 이를 명시적으로 지정해야 합니다. 시간대를 지정하지 않으면 UTC가 기본값으로 사용됩니다.

2. **일관성**: 애플리케이션 전체에서 날짜 형식을 일관되게 사용하여 혼란을 방지하세요.

3. **명시적 매핑**: 항상 날짜 필드의 형식을 명시적으로 정의하여 예상치 못한 파싱 오류를 방지하세요.

4. **형식 유연성**: 여러 날짜 형식을 지원해야 하는 경우, 매핑에서 여러 형식을 파이프(`||`)로 구분하여 지정할 수 있습니다.

## 결론

Elasticsearch의 날짜 타입 처리는 매우 유연하며, 다양한 날짜 형식과 표현 방식을 지원합니다. 그러나 인덱싱 시와 검색 시의 형식 제약은 다르다는 점에 주의해야 합니다. 명시적인 매핑과 형식 정의를 통해 데이터의 일관성을 유지하고, 검색 시에는 Elasticsearch가 지원하는 표준 형식을 사용하여 검색 및 집계의 정확도를 높일 수 있습니다.
